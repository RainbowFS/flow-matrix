#!/usr/bin/env python
# -*- coding: utf-8 -*-

from flask import Flask
from jinja2 import Environment, PackageLoader
from flowmatrix.flowlib import get_data_full, get_data
import argparse
import os

app = Flask(__name__)
app.debug = True
app.autoescape = False

parser = argparse.ArgumentParser(description='Start Flask app for flow matrix')
parser.add_argument('--influxdb_host', type=str, help='hostname or IP for the influxdb server', required=True)
parser.add_argument('--flow_matrix_port', type=int, help='the port on which to run the flow_matrix', default=5011)
parser.add_argument('--influxdb_port', type=str, help='port of the influxdb server', default="8086")
parser.add_argument('--influxdb_database', type=str, help='database to used in the influxdb server', default="telegraf")

args = parser.parse_args()

e = Environment(loader=PackageLoader("flowmatrix", "../flowmatrix/templates/"))


@app.route("/")
def data():
    matrix, svg = get_data(args.influxdb_host, args.influxdb_port)
    return e.get_template("index.html").render(data=matrix.to_dict(), svg=svg)


@app.route("/full")
def data_full():
    matrix, svg = get_data_full(args.influxdb_host, args.influxdb_port)
    return e.get_template("index.html").render(data=matrix.to_dict(), svg=svg)

app.run(host="0.0.0.0", port=args.flow_matrix_port)
